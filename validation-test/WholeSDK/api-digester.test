// This test compares the behavior of the toolchain compiler to the just-built
// compiler using the currently installed SDK. That means its behavior depends
// on the installed toolchain compiler and SDK. If you have trouble reproducing
// a failure locally, make sure you're using the same Xcode that was used when
// the test failure occurred.

// Some failures will indicate regressions, but others will indicate intentional
// changes to compiler behavior. If a failure is caused by an intentional
// change, add it to the appropriate section of
// 'Inputs/intentionally-changed-apis.txt'.

// REQUIRES: VENDOR=apple

// RUN: %empty-directory(%t)
// RUN: %empty-directory(%t/module-cache)

// Generate a baseline digest using the toolchain API digester, capturing how the host toolchain imports APIs.
// RUN: time env xcrun swift-api-digester -target %target-triple -dump-sdk -module-list-file %s -o %t/baseline.json -module-cache-path %t/module-cache -sdk %sdk -swift-version 5 -avoid-location -avoid-tool-args

// Generate a digest using the just-built API digester, capturing how the just-built compiler imports APIs.
// RUN: time %api-digester -dump-sdk -module-list-file %s -o %t/result.json -module-cache-path %t/module-cache -sdk %sdk -swift-version 5 -avoid-location -avoid-tool-args

// Compare them.
// RUN: time %api-digester -diagnose-sdk -module-list-file %s -input-paths %t/baseline.json -input-paths %t/result.json -module-cache-path %t/module-cache -sdk %sdk -swift-version 5 -avoid-location -avoid-tool-args -breakage-allowlist-path %S/Inputs/intentionally-changed-apis.txt

// FIXME: Forces the test to fail so we can see the output from `time`
// RUN: false

// List of modules to test. Please keep it alphabetical.
// Missing modules will not cause the test to fail.

AppKit
Darwin
Dispatch
Foundation
SwiftUI
UIKit
WatchKit
